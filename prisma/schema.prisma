generator client {
  provider     = "prisma-client-js"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------
// 1. COMPANY (Tenant)
// ---------------------------------------------------------
model Company {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @db.VarChar(255)
  cif       String?  @unique @db.VarChar(50)
  logoUrl   String?  @map("logo_url")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  billingPlan           BillingPlan @default(BASIC) @map("billing_plan")
  allowUserEditSchedule Boolean     @default(false) @map("allow_user_edit_schedule")
  inviteCode            String?     @unique @map("invite_code") @db.VarChar(20)

  // Relations
  users             User[]
  projects          Project[]
  projectCategories ProjectCategory[]
  externalWorkers   ExternalWorker[]
  timeEntries       TimeEntry[]
  workSchedules     WorkSchedule[]
  activeTimers      ActiveTimer[]
  externalHours     ExternalHours[]
  invitations       CompanyInvitation[]
  joinRequests      JoinRequest[]

  @@map("companies")
}

enum BillingPlan {
  BASIC
  PRO
}

// ---------------------------------------------------------
// 2. USERS (Internal Employees & Guests)
// ---------------------------------------------------------
model User {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String @map("company_id") @db.Uuid
  authId String @map("auth_id") @db.Uuid

  email     String  @db.VarChar(320)
  name      String  @db.VarChar(255)
  phone     String?
  avatarUrl String? @map("avatar_url")

  hourlyCost Decimal @map("hourly_cost") @db.Decimal(8, 2)
  isActive   Boolean @default(true) @map("is_active")

  relationType RelationType @default(EMPLOYEE) @map("relation_type")
  role         UserRole     @default(WORKER)

  nif String?
  naf String?

  // Relations
  workSchedules        WorkSchedule[]
  notificationSettings NotificationSettings?

  company Company @relation(fields: [companyId], references: [id])

  timeEntries TimeEntry[]
  activeTimer ActiveTimer?
  auditLogs   AuditLog[]   @relation("Actor")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@unique([companyId, email])
  @@unique([companyId, phone])
  @@index([authId])
  @@map("users")
}

enum RelationType {
  EMPLOYEE
  CONTRACTOR
  GUEST
}

enum UserRole {
  OWNER
  ADMIN
  WORKER
  AUDITOR
}

// ---------------------------------------------------------
// 3. SCHEDULES & NOTIFICATIONS
// ---------------------------------------------------------
model WorkSchedule {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  companyId String  @map("company_id") @db.Uuid
  userId    String? @map("user_id") @db.Uuid

  dayOfWeek Int    @map("day_of_week")
  startTime String @map("start_time")
  endTime   String @map("end_time")

  company Company @relation(fields: [companyId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])

  @@unique([companyId, userId, dayOfWeek])
  @@map("work_schedules")
}

model NotificationSettings {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  enableReminders  Boolean       @default(true) @map("enable_reminders")
  channel          NotifyChannel @default(WHATSAPP)
  toleranceMinutes Int           @default(15) @map("tolerance_minutes")

  user User @relation(fields: [userId], references: [id])

  @@map("notification_settings")
}

enum NotifyChannel {
  EMAIL
  WHATSAPP
}

// ---------------------------------------------------------
// 4. PROJECTS, CATEGORIES & FINANCIALS
// ---------------------------------------------------------
model Project {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String  @map("company_id") @db.Uuid
  categoryId String? @map("category_id") @db.Uuid

  name     String  @db.VarChar(255)
  code     String  @db.VarChar(50)
  isActive Boolean @default(true) @map("is_active")

  company  Company          @relation(fields: [companyId], references: [id])
  category ProjectCategory? @relation(fields: [categoryId], references: [id])

  timeEntries    TimeEntry[]
  externalHours  ExternalHours[]
  activeTimers   ActiveTimer[]
  financialItems ProjectFinancialItem[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("projects")
}

model ProjectCategory {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String  @map("company_id") @db.Uuid
  name      String  @db.VarChar(100)
  color     String?

  company  Company   @relation(fields: [companyId], references: [id])
  projects Project[]

  @@map("project_categories")
}

model ProjectFinancialItem {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  type     FinancialType
  category FinancialCategory

  description String   @db.VarChar(255)
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @db.Date

  project Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("project_financial_items")
}

enum FinancialType {
  REVENUE
  EXPENSE
}

enum FinancialCategory {
  EXTERNAL_SERVICE
  GENERAL_COST
  TAX
  INCOME
  OTHER
}

// ---------------------------------------------------------
// 5. TIME TRACKING
// ---------------------------------------------------------
model ActiveTimer {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String  @unique @map("user_id") @db.Uuid
  companyId String  @map("company_id") @db.Uuid
  projectId String? @map("project_id") @db.Uuid

  startTime DateTime  @map("start_time") @db.Timestamptz(6)
  entryType EntryType @default(WORK) @map("entry_type")
  isInOffice Boolean  @default(false) @map("is_in_office")

  lat       Float?
  lng       Float?
  ipAddress String? @map("ip_address")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  company Company  @relation(fields: [companyId], references: [id])

  @@map("active_timers")
}

model TimeEntry {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  companyId String  @map("company_id") @db.Uuid
  projectId String? @map("project_id") @db.Uuid

  startTime       DateTime @map("start_time") @db.Timestamptz(6)
  endTime         DateTime @map("end_time") @db.Timestamptz(6)
  durationMinutes Int      @map("duration_minutes")

  entryType EntryType   @default(WORK) @map("entry_type")
  source    EntrySource @default(WEB)
  isInOffice Boolean    @default(false) @map("is_in_office")

  startLat Float?  @map("start_lat")
  startLng Float?  @map("start_lng")
  startIp  String? @map("start_ip")
  endLat   Float?  @map("end_lat")
  endLng   Float?  @map("end_lng")
  endIp    String? @map("end_ip")

  isManual   Boolean @default(false) @map("is_manual")
  isModified Boolean @default(false) @map("is_modified")

  user      User       @relation(fields: [userId], references: [id])
  company   Company    @relation(fields: [companyId], references: [id])
  project   Project?   @relation(fields: [projectId], references: [id])
  auditLogs AuditLog[]

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, startTime])
  @@map("time_entries")
}

enum EntryType {
  WORK
  PAUSE_COFFEE
  PAUSE_LUNCH
  PAUSE_PERSONAL
}

enum EntrySource {
  WEB
  APP
  WHATSAPP
}

// ---------------------------------------------------------
// 6. COMPLIANCE AUDIT LOG
// ---------------------------------------------------------
model AuditLog {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  timeEntryId String @map("time_entry_id") @db.Uuid
  actorId     String @map("actor_id") @db.Uuid

  action  String
  reason  String
  changes Json

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id])
  actor     User      @relation("Actor", fields: [actorId], references: [id])

  timestamp DateTime @default(now())

  @@map("audit_logs")
}

// ---------------------------------------------------------
// 7. EXTERNAL WORKERS
// ---------------------------------------------------------
model ExternalWorker {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String  @map("company_id") @db.Uuid
  name       String  @db.VarChar(255)
  hourlyCost Decimal @map("hourly_cost") @db.Decimal(8, 2)
  isActive   Boolean @default(true) @map("is_active")

  company       Company         @relation(fields: [companyId], references: [id])
  externalHours ExternalHours[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("external_workers")
}

model ExternalHours {
  id               String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  externalWorkerId String @map("external_worker_id") @db.Uuid
  projectId        String @map("project_id") @db.Uuid
  companyId        String @map("company_id") @db.Uuid

  date    DateTime @db.Date
  minutes Int
  cost    Decimal  @default(0) @db.Decimal(10, 2)

  externalWorker ExternalWorker @relation(fields: [externalWorkerId], references: [id])
  project        Project        @relation(fields: [projectId], references: [id])
  company        Company        @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("external_hours")
}

// ---------------------------------------------------------
// 8. COMPANY INVITATIONS & JOIN REQUESTS
// ---------------------------------------------------------
model CompanyInvitation {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId    String       @map("company_id") @db.Uuid
  email        String       @db.VarChar(320)
  role         UserRole     @default(WORKER)
  relationType RelationType @default(EMPLOYEE) @map("relation_type")
  token        String       @unique @db.VarChar(64)
  expiresAt    DateTime     @map("expires_at") @db.Timestamptz(6)
  usedAt       DateTime?    @map("used_at") @db.Timestamptz(6)
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  company Company @relation(fields: [companyId], references: [id])

  @@index([email])
  @@map("company_invitations")
}

model JoinRequest {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId    String            @map("company_id") @db.Uuid
  authId       String            @map("auth_id") @db.Uuid
  email        String            @db.VarChar(320)
  name         String            @db.VarChar(255)
  status       JoinRequestStatus @default(PENDING)
  reviewedAt   DateTime?         @map("reviewed_at") @db.Timestamptz(6)
  reviewedById String?           @map("reviewed_by_id") @db.Uuid
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, authId])
  @@index([authId])
  @@map("join_requests")
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
